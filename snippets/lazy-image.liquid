{%- comment -%}
  RecoverSups Optimized Lazy Loading Image Snippet
  
  Usage:
  {% render 'lazy-image', 
     image: product.featured_image, 
     alt: product.title,
     class: 'product-image',
     aspect_ratio: '1-1',
     sizes: '(min-width: 768px) 50vw, 100vw',
     priority: 'high',
     blur_placeholder: true %}
{%- endcomment -%}

{%- liquid
  assign aspect_ratio = aspect_ratio | default: '1-1'
  assign sizes = sizes | default: '100vw'
  assign loading = loading | default: 'lazy'
  assign class = class | default: ''
  assign priority = priority | default: 'medium'
  assign blur_placeholder = blur_placeholder | default: false
  assign placeholder_class = 'lazy-image-container ratio-' | append: aspect_ratio | append: ' priority-' | append: priority
  
  if class != blank
    assign placeholder_class = placeholder_class | append: ' ' | append: class
  endif
  
  if image
    assign alt_text = alt | default: image.alt | default: 'Product image'
    assign image_width = image.width | default: 800
    assign image_height = image.height | default: 800
  else
    assign alt_text = alt | default: 'Image not available'
    assign image_width = 800
    assign image_height = 800
  endif
-%}

<div class="{{ placeholder_class }}">
  {%- if image -%}
    {%- if blur_placeholder -%}
      <img
        class="lazy-image-blur-placeholder"
        src="{{ image | image_url: width: 50 }}"
        alt=""
        aria-hidden="true"
        style="filter: blur(20px); transform: scale(1.2);"
      >
    {%- endif -%}
    
    <img
      data-src="{{ image | image_url: width: image_width }}"
      data-srcset="
        {{ image | image_url: width: 200 }} 200w,
        {{ image | image_url: width: 400 }} 400w,
        {{ image | image_url: width: 600 }} 600w,
        {{ image | image_url: width: 800 }} 800w,
        {{ image | image_url: width: 1200 }} 1200w
      "
      sizes="{{ sizes }}"
      alt="{{ alt_text | escape }}"
      loading="{{ loading }}"
      decoding="async"
      width="{{ image_width }}"
      height="{{ image_height }}"
      class="lazy-image"
      data-priority="{{ priority }}"
    >
    
    <div class="lazy-image-spinner" aria-hidden="true">
      <div class="lazy-image-spinner-icon"></div>
    </div>
    
  {%- else -%}
    <div class="lazy-image-placeholder no-image">
      <svg class="lazy-image-placeholder-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
        <circle cx="8.5" cy="8.5" r="1.5"/>
        <polyline points="21,15 16,10 5,21"/>
      </svg>
    </div>
  {%- endif -%}
</div>

{%- comment -%}
  Example usage in templates:
  
  <!-- Product image with lazy loading -->
  {% render 'lazy-image', 
     image: product.featured_image, 
     alt: product.title,
     class: 'product-featured-image',
     aspect_ratio: '1-1',
     sizes: '(min-width: 1024px) 33vw, (min-width: 768px) 50vw, 100vw' %}
  
  <!-- Collection image -->
  {% render 'lazy-image', 
     image: collection.featured_image, 
     alt: collection.title,
     class: 'collection-hero-image',
     aspect_ratio: '16-9',
     sizes: '100vw' %}
  
  <!-- Article image -->
  {% render 'lazy-image', 
     image: article.image, 
     alt: article.title,
     class: 'article-featured-image',
     aspect_ratio: '3-2',
     sizes: '(min-width: 768px) 60vw, 100vw' %}
{%- endcomment -%}