{% comment %}
  Product Card Component - RecoverSups Theme
  
  Description: Universal product card for displaying products across the site
  
  Parameters:
    - product {Object} Required: Product object from Shopify
    - show_vendor {Boolean} Optional: Display product vendor (default: false)
    - show_description {Boolean} Optional: Display product description (default: true)
    - show_quick_add {Boolean} Optional: Show quick add to cart (default: true)
    - image_size {String} Optional: Image size ('small', 'medium', 'large') (default: 'medium')
    - card_style {String} Optional: Card style ('standard', 'minimal', 'featured') (default: 'standard')
    - fitness_goal {String} Optional: Fitness goal modifier ('muscle', 'energy', 'recovery', 'endurance', 'weight')
  
  Usage:
    {% render 'product-card', product: product, show_vendor: true, fitness_goal: 'muscle' %}
  
  Dependencies:
    - CSS: component-product-card.css
    - JS: cart-manager.js (for add to cart functionality)
  
  Accessibility:
    - Keyboard navigable
    - Screen reader optimized
    - ARIA labels included
    - Focus management
{% endcomment %}

{%- liquid
  assign show_vendor = show_vendor | default: false
  assign show_description = show_description | default: true  
  assign show_quick_add = show_quick_add | default: true
  assign image_size = image_size | default: 'medium'
  assign card_style = card_style | default: 'standard'
  
  case image_size
    when 'small'
      assign image_width = 300
      assign image_height = 300
    when 'large'
      assign image_width = 600
      assign image_height = 600
    else
      assign image_width = 400
      assign image_height = 400
  endcase
  
  assign on_sale = false
  if product.compare_at_price > product.price
    assign on_sale = true
    assign discount_amount = product.compare_at_price | minus: product.price
    assign discount_percent = discount_amount | times: 100 | divided_by: product.compare_at_price | round
  endif
-%}

<div class="product-card product-card--{{ card_style }}{% if fitness_goal %} product-card--{{ fitness_goal }}{% endif %}{% if on_sale %} product-card--on-sale{% endif %}" 
     data-product-id="{{ product.id }}"
     data-product-handle="{{ product.handle }}">
  
  <!-- Product Image Container -->
  <div class="product-card__image-container">
    <a href="{{ product.url }}" 
       class="product-card__image-link"
       aria-label="View {{ product.title | escape }}">
      
      {% if product.featured_image %}
        <img src="{{ product.featured_image | image_url: width: image_width, height: image_height }}"
             alt="{{ product.featured_image.alt | default: product.title | escape }}"
             class="product-card__image"
             loading="lazy"
             width="{{ image_width }}"
             height="{{ image_height }}">
        
        <!-- Hover Image (if available) -->
        {% if product.images[1] %}
          <img src="{{ product.images[1] | image_url: width: image_width, height: image_height }}"
               alt="{{ product.images[1].alt | default: product.title | escape }}"
               class="product-card__image product-card__image--hover"
               loading="lazy"
               width="{{ image_width }}"
               height="{{ image_height }}">
        {% endif %}
      {% else %}
        <div class="product-card__placeholder">
          <svg class="product-card__placeholder-icon" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1">
            <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
            <circle cx="8.5" cy="8.5" r="1.5"/>
            <polyline points="21,15 16,10 5,21"/>
          </svg>
        </div>
      {% endif %}
    </a>
    
    <!-- Product Badges -->
    <div class="product-card__badges">
      {% if on_sale %}
        <span class="product-card__badge product-card__badge--sale">
          -{{ discount_percent }}%
        </span>
      {% endif %}
      
      {% if product.tags contains 'new' %}
        <span class="product-card__badge product-card__badge--new">
          New
        </span>
      {% endif %}
      
      {% if product.tags contains 'bestseller' %}
        <span class="product-card__badge product-card__badge--bestseller">
          Bestseller
        </span>
      {% endif %}
      
      {% comment %} Supplement-specific badges {% endcomment %}
      {% if product.tags contains 'vegan' %}
        <span class="product-card__badge product-card__badge--vegan">
          Vegan
        </span>
      {% endif %}
      
      {% if product.tags contains 'gluten-free' %}
        <span class="product-card__badge product-card__badge--gluten-free">
          Gluten Free
        </span>
      {% endif %}
    </div>
    
    <!-- Quick Actions -->
    <div class="product-card__quick-actions">
      {% if show_quick_add and product.available %}
        <button type="button" 
                class="product-card__quick-add"
                data-product-form
                data-product-id="{{ product.id }}"
                data-variant-id="{{ product.selected_or_first_available_variant.id }}"
                aria-label="Quick add {{ product.title | escape }} to cart">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M3 3h2l.4 2M7 13h10l4-8H5.4m1.6 8L5 3H3"/>
            <circle cx="9" cy="21" r="1"/>
            <circle cx="20" cy="21" r="1"/>
          </svg>
          <span class="visually-hidden">Add to cart</span>
        </button>
      {% endif %}
      
      <!-- Quick View Button -->
      <button type="button" 
              class="product-card__quick-view"
              data-quick-view="{{ product.handle }}"
              aria-label="Quick view {{ product.title | escape }}">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/>
          <circle cx="12" cy="12" r="3"/>
        </svg>
        <span class="visually-hidden">Quick view</span>
      </button>
    </div>
  </div>
  
  <!-- Product Info -->
  <div class="product-card__info">
    {% if show_vendor and product.vendor != blank %}
      <div class="product-card__vendor">
        {{ product.vendor }}
      </div>
    {% endif %}
    
    <h3 class="product-card__title">
      <a href="{{ product.url }}" 
         class="product-card__title-link">
        {{ product.title }}
      </a>
    </h3>
    
    {% if show_description and product.description != blank %}
      <div class="product-card__description">
        {{ product.description | strip_html | truncate: 120 }}
      </div>
    {% endif %}
    
    <!-- Supplement-specific Info -->
    {% if product.metafields.supplements.servings_per_container %}
      <div class="product-card__supplement-info">
        <span class="product-card__servings">
          {{ product.metafields.supplements.servings_per_container }} servings
        </span>
        {% if product.metafields.supplements.flavor %}
          <span class="product-card__flavor">
            {{ product.metafields.supplements.flavor }}
          </span>
        {% endif %}
      </div>
    {% endif %}
    
    <!-- Star Rating (if using review app) -->
    {% if product.metafields.reviews.rating.value %}
      <div class="product-card__rating">
        <div class="star-rating" aria-label="Rating: {{ product.metafields.reviews.rating.value }} out of 5 stars">
          {% assign rating = product.metafields.reviews.rating.value | round %}
          {% for i in (1..5) %}
            <svg class="star{% if i <= rating %} star--filled{% endif %}" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1">
              <polygon points="12,2 15.09,8.26 22,9.27 17,14.14 18.18,21.02 12,17.77 5.82,21.02 7,14.14 2,9.27 8.91,8.26"/>
            </svg>
          {% endfor %}
        </div>
        {% if product.metafields.reviews.rating_count.value %}
          <span class="product-card__rating-count">
            ({{ product.metafields.reviews.rating_count.value }})
          </span>
        {% endif %}
      </div>
    {% endif %}
    
    <!-- Price -->
    <div class="product-card__price">
      {% if on_sale %}
        <span class="product-card__price-sale">
          {{ product.price | money }}
        </span>
        <span class="product-card__price-compare">
          {{ product.compare_at_price | money }}
        </span>
      {% else %}
        <span class="product-card__price-regular">
          {% if product.price_varies %}
            From {{ product.price_min | money }}
          {% else %}
            {{ product.price | money }}
          {% endif %}
        </span>
      {% endif %}
    </div>
    
    <!-- Variant Options Preview (if single option like size/flavor) -->
    {% if product.options.size == 1 and product.variants.size > 1 and product.variants.size <= 4 %}
      <div class="product-card__variant-preview">
        {% assign option_name = product.options[0] %}
        <div class="product-card__variant-label">{{ option_name }}:</div>
        <div class="product-card__variant-options">
          {% for variant in product.variants limit: 4 %}
            <button type="button" 
                    class="product-card__variant-option{% unless variant.available %} product-card__variant-option--unavailable{% endunless %}"
                    data-variant-id="{{ variant.id }}"
                    data-variant-price="{{ variant.price }}"
                    {% unless variant.available %}disabled{% endunless %}
                    title="{{ variant.title }}{% unless variant.available %} - Sold Out{% endunless %}">
              {{ variant.options[0] }}
            </button>
          {% endfor %}
        </div>
      </div>
    {% endif %}
    
    <!-- Add to Cart Form -->
    {% if product.available %}
      <form action="/cart/add" 
            method="post" 
            enctype="multipart/form-data" 
            class="product-card__form" 
            data-product-form>
        
        {% unless product.has_only_default_variant %}
          <input type="hidden" 
                 name="id" 
                 value="{{ product.selected_or_first_available_variant.id }}" 
                 data-variant-id>
        {% else %}
          <input type="hidden" 
                 name="id" 
                 value="{{ product.variants[0].id }}">
        {% endunless %}
        
        <button type="submit" 
                class="product-card__add-to-cart btn btn--primary btn--full"
                data-add-to-cart>
          <span class="product-card__add-to-cart-text">Add to Cart</span>
          <div class="product-card__add-to-cart-loading hidden">
            <div class="loading-spinner"></div>
            Adding...
          </div>
        </button>
      </form>
    {% else %}
      <button type="button" 
              class="product-card__add-to-cart btn btn--secondary btn--full" 
              disabled>
        Sold Out
      </button>
    {% endif %}
  </div>
</div>