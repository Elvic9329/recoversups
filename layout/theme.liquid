<!doctype html>
<html class="no-js" lang="{{ request.locale.iso_code }}" dir="{{ settings.text_direction }}">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <meta name="theme-color" content="#b62921">
  <meta name="format-detection" content="telephone=no">
  
  <!-- Performance Hints - Critical connections -->
  <link rel="preconnect" href="https://cdn.shopify.com" crossorigin>
  <link rel="preconnect" href="https://fonts.shopifycdn.com" crossorigin>
  <link rel="preconnect" href="https://fonts.googleapis.com" crossorigin>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link rel="dns-prefetch" href="//shopify-pay.shopifycs.com">
  <link rel="dns-prefetch" href="//ajax.googleapis.com">
  
  <!-- Title Optimization -->
  <title>
    {%- if page_title == blank -%}
      {{- shop.name -}}
    {%- elsif page_title contains shop.name -%}
      {{- page_title -}}
    {%- else -%}
      {{- page_title | append: ' - ' | append: shop.name -}}
    {%- endif -%}
  </title>
  
  <!-- Meta Description -->
  {%- if page_description -%}
    <meta name="description" content="{{ page_description | escape | truncate: 160 }}">
  {%- elsif shop.description != blank -%}
    <meta name="description" content="{{ shop.description | escape | truncate: 160 }}">
  {%- endif -%}
  
  <!-- Canonical URL -->
  <link rel="canonical" href="{{ canonical_url }}">
  
  <!-- Favicon -->
  {%- if settings.favicon != blank -%}
    <link rel="icon" type="image/png" href="{{ settings.favicon | image_url: width: 32, height: 32 }}">
    <link rel="apple-touch-icon" href="{{ settings.favicon | image_url: width: 180, height: 180 }}">
  {%- endif -%}
  
  <!-- Open Graph -->
  <meta property="og:site_name" content="{{ shop.name }}">
  <meta property="og:url" content="{{ canonical_url }}">
  <meta property="og:title" content="{{ page_title | default: shop.name }}">
  <meta property="og:type" content="website">
  <meta property="og:description" content="{{ page_description | default: shop.description | default: shop.name | escape | truncate: 160 }}">
  
  {%- liquid
    assign og_image = false
    assign og_image_alt = ''
    
    if template.name == 'product' and product.featured_media
      assign og_image = product.featured_media.preview_image
      assign og_image_alt = product.featured_media.alt | escape
    elsif template.name == 'collection' and collection.featured_image
      assign og_image = collection.featured_image
      assign og_image_alt = collection.title | escape
    elsif blog.image
      assign og_image = blog.image
      assign og_image_alt = blog.title | escape
    elsif article.image
      assign og_image = article.image
      assign og_image_alt = article.title | escape
    endif
  -%}
  
  {%- if og_image -%}
    <meta property="og:image" content="{{ og_image | image_url: width: 1200, height: 630 }}">
    <meta property="og:image:secure_url" content="{{ og_image | image_url: width: 1200, height: 630 }}">
    <meta property="og:image:width" content="1200">
    <meta property="og:image:height" content="630">
    <meta property="og:image:alt" content="{{ og_image_alt }}">
  {%- endif -%}
  
  <!-- Twitter Card -->
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:title" content="{{ page_title | default: shop.name }}">
  <meta name="twitter:description" content="{{ page_description | default: shop.description | default: shop.name | escape | truncate: 160 }}">
  
  {%- comment -%} Critical CSS Inline - Above the fold only {%- endcomment -%}
  <style>
    /* Critical above-the-fold styles - Optimized for FCP */
    *,*::before,*::after{box-sizing:border-box}html{font-size:16px;-webkit-text-size-adjust:100%;scroll-behavior:smooth}body{margin:0;font-family:Montserrat,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,sans-serif;background:#fff;color:#1a202c;line-height:1.5;-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale}.no-js{visibility:hidden}.js .no-js{visibility:visible}.skip-link{position:absolute;top:-40px;left:6px;background:#b62921;color:#fff;padding:8px 16px;text-decoration:none;border-radius:4px;z-index:9999;transition:top 150ms ease-in-out}.skip-link:focus{top:6px}.page-width{max-width:1280px;margin:0 auto;padding:0 16px}.site-header{position:sticky;top:0;background:#fff;border-bottom:1px solid #cbd5e0;z-index:1000;backdrop-filter:blur(10px);transform:translateZ(0)}.loading{opacity:0.7;pointer-events:none}.dark{--bg:#1a1a1a;--fg:#f7fafc;--border:#4a5568}.dark body{background:var(--bg);color:var(--fg)}.dark .site-header{background:var(--bg);border-color:var(--border)}@media(max-width:640px){.page-width{padding:0 8px}}html.loading body{visibility:hidden}html.loaded body{visibility:visible}
  </style>
  
  <!-- Critical CSS preload and async loading -->
  <link rel="preload" href="{{ 'theme.css' | asset_url }}" as="style" onload="this.onload=null;this.rel='stylesheet'">
  <noscript><link rel="stylesheet" href="{{ 'theme.css' | asset_url }}"></noscript>
  
  <!-- Font loading optimization with preload -->
  <link rel="preconnect" href="https://fonts.googleapis.com" crossorigin>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link rel="preload" href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500;600;700&family=Lora:ital,wght@0,400;1,400&display=swap" as="style" onload="this.onload=null;this.rel='stylesheet'">
  <noscript>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500;600;700&family=Lora:ital,wght@0,400;1,400&display=swap" rel="stylesheet">
  </noscript>
  
  <!-- Required Shopify head content -->
  {{ content_for_header }}
  
  <!-- Theme JSON-LD Structured Data -->
  {%- liquid
    assign search_url_template = request.origin | append: routes.search_url | append: '?q={search_term_string}'
  -%}
  <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@type": "WebSite",
      "name": {{ shop.name | json }},
      "url": {{ request.origin | append: page.url | json }},
      "description": {{ shop.description | default: shop.name | json }},
      "potentialAction": {
        "@type": "SearchAction",
        "target": {
          "@type": "EntryPoint",
          "urlTemplate": {{ search_url_template | json }}
        },
        "query-input": "required name=search_term_string"
      }
    }
  </script>
</head>
<body class="template-{{ template.name | handle }} page-{{ page.handle | default: 'default' }}">
  <!-- Skip to content link for accessibility -->
  <a href="#main-content" class="skip-link">Saltar al contenido principal</a>
  
  <!-- Theme Detection Script (Critical) -->
  <script>
    // Mark as loading for FOUC prevention
    document.documentElement.classList.add('loading');
    document.documentElement.classList.remove('no-js');
    document.documentElement.classList.add('js');
    
    // Dark mode detection - Always start in light mode unless explicitly set to dark
    if (localStorage.getItem('rs-theme') === 'dark') {
      document.documentElement.classList.add('dark');
    } else {
      // Ensure light mode is set if no preference exists
      if (!localStorage.getItem('rs-theme')) {
        localStorage.setItem('rs-theme', 'light');
      }
    }
    
    // Progressive enhancement and performance tracking
    window.RS = window.RS || {};
    window.RS.performance = {
      startTime: performance.now(),
      markers: []
    };
    
    // Mark critical script loaded
    window.RS.performance.markers.push({
      name: 'critical-script-loaded',
      time: performance.now()
    });
    
    // Progressive loading state management
    window.RS.loadingStates = {
      critical: true,
      fonts: false,
      css: false,
      js: false
    };
  </script>
  
  <!-- Header -->
  <header class="site-header" role="banner">
    {%- section 'header' -%}
  </header>
  
  <!-- Main content with proper landmarks -->
  <main id="main-content" class="main-content" role="main" tabindex="-1">
    <div class="page-width">
      {{ content_for_layout }}
    </div>
  </main>
  
  <!-- Footer -->
  <footer class="site-footer" role="contentinfo">
    {%- section 'footer' -%}
  </footer>
  
  <!-- Critical JavaScript -->
  <script>
    // RecoverSups Theme Configuration
    window.RS = window.RS || {};
    window.RS.theme = {
      name: 'RecoverSups',
      version: '1.0.0',
      locale: {{ request.locale.iso_code | json }},
      currency: {{ cart.currency.iso_code | json }},
      moneyFormat: {{ shop.money_format | json }},
      routes: {
        root: {{ routes.root_url | json }},
        cart: {{ routes.cart_url | json }},
        cartAdd: {{ routes.cart_add_url | json }},
        cartChange: {{ routes.cart_change_url | json }},
        search: {{ routes.search_url | json }}
      },
      strings: {
        addToCart: 'AÃ±adir al carrito',
        soldOut: 'Agotado',
        unavailable: 'No disponible'
      }
    };
    
    // Performance monitoring
    if (window.performance && window.performance.mark) {
      performance.mark('rs-theme-start');
    }
  </script>
  
  <!-- Deferred JavaScript Loading -->
  <script src="{{ 'global.js' | asset_url }}" defer></script>
  <script src="{{ 'header.js' | asset_url }}" defer></script>
  <script src="{{ 'search.js' | asset_url }}" defer></script>
  
  <!-- Development Tools -->
  {%- if request.design_mode -%}
    <script src="{{ 'responsive-test.js' | asset_url }}" defer></script>
  {%- endif -%}
  
  <!-- Shopify Analytics -->
  {%- if shop.enabled_currencies.size > 1 -%}
    <script>
      window.shop = window.shop || {};
      window.shop.currencies = {{ shop.enabled_currencies | json }};
    </script>
  {%- endif -%}
  
  <!-- Theme Editor Scripts -->
  {%- if request.design_mode -%}
    <script>
      // Enhanced theme editor functionality
      document.addEventListener('shopify:section:load', function(event) {
        console.log('Section loaded:', event.detail.sectionId);
        
        // Reinitialize components if needed
        if (window.RS && window.RS.reinitializeSection) {
          window.RS.reinitializeSection(event.detail.sectionId);
        }
        
        // Dispatch custom event for component reinitialization
        document.dispatchEvent(new CustomEvent('rs:section:load', {
          detail: { sectionId: event.detail.sectionId }
        }));
      });
      
      document.addEventListener('shopify:section:unload', function(event) {
        console.log('Section unloaded:', event.detail.sectionId);
        
        // Cleanup components if needed
        if (window.RS && window.RS.cleanupSection) {
          window.RS.cleanupSection(event.detail.sectionId);
        }
      });
      
      document.addEventListener('shopify:section:select', function(event) {
        console.log('Section selected:', event.detail.sectionId);
      });
      
      document.addEventListener('shopify:section:deselect', function(event) {
        console.log('Section deselected:', event.detail.sectionId);
      });
      
      document.addEventListener('shopify:block:select', function(event) {
        console.log('Block selected:', event.detail.blockId);
      });
      
      document.addEventListener('shopify:block:deselect', function(event) {
        console.log('Block deselected:', event.detail.blockId);
      });
    </script>
  {%- endif -%}
  
  <!-- Performance metrics and progressive loading completion -->
  <script>
    // CSS loading callback
    function onStylesLoaded() {
      window.RS.loadingStates.css = true;
      window.RS.performance.markers.push({
        name: 'css-loaded',
        time: performance.now()
      });
      checkLoadingComplete();
    }
    
    // Font loading callback
    function onFontsLoaded() {
      window.RS.loadingStates.fonts = true;
      window.RS.performance.markers.push({
        name: 'fonts-loaded',
        time: performance.now()
      });
      checkLoadingComplete();
    }
    
    // Check if all critical resources are loaded
    function checkLoadingComplete() {
      if (window.RS.loadingStates.css && window.RS.loadingStates.fonts) {
        document.documentElement.classList.remove('loading');
        document.documentElement.classList.add('loaded');
        
        window.RS.performance.markers.push({
          name: 'theme-loaded',
          time: performance.now()
        });
      }
    }
    
    // Final load event with comprehensive metrics
    window.addEventListener('load', function() {
      window.RS.loadingStates.js = true;
      
      if (window.performance && window.performance.mark) {
        performance.mark('rs-theme-end');
        performance.measure('rs-theme-load', 'rs-theme-start', 'rs-theme-end');
        
        // Comprehensive performance data
        const perfData = {
          domContentLoaded: performance.timing.domContentLoadedEventEnd - performance.timing.navigationStart,
          loadComplete: performance.timing.loadEventEnd - performance.timing.navigationStart,
          themeLoad: performance.getEntriesByName('rs-theme-load')[0]?.duration || 0,
          markers: window.RS.performance.markers,
          totalThemeTime: performance.now() - window.RS.performance.startTime
        };
        
        // Performance analysis
        {%- unless request.design_mode -%}
          console.log('RecoverSups Performance Metrics:', perfData);
          
          // Track Web Vitals if available
          if (typeof webVitals !== 'undefined') {
            webVitals.getFCP(console.log);
            webVitals.getLCP(console.log);
            webVitals.getCLS(console.log);
          }
        {%- endunless -%}
      }
      
      // Final loading state update
      checkLoadingComplete();
    });
    
    // Set callbacks for async loaded resources
    document.addEventListener('DOMContentLoaded', function() {
      // Trigger callbacks when resources load
      const styleLinks = document.querySelectorAll('link[rel="stylesheet"], link[onload]');
      styleLinks.forEach(link => {
        if (link.sheet || link.href.includes('fonts.googleapis.com')) {
          if (link.href.includes('fonts.googleapis.com')) {
            onFontsLoaded();
          } else {
            onStylesLoaded();
          }
        } else {
          link.addEventListener('load', () => {
            if (link.href.includes('fonts.googleapis.com')) {
              onFontsLoaded();
            } else {
              onStylesLoaded();
            }
          });
        }
      });
    });
  </script>
</body>
</html>