{%- assign main_menu = section.settings.main_menu -%}
{%- assign mobile_menu = section.settings.mobile_menu -%}
{%- assign logo = section.settings.logo -%}

{%- liquid
  assign logo_width = section.settings.logo_width
  assign logo_height = section.settings.logo_height
  assign enable_sticky_header = section.settings.enable_sticky_header
  assign enable_search = section.settings.enable_search
  assign enable_cart_drawer = section.settings.enable_cart_drawer
  assign enable_account_links = section.settings.enable_account_links
  assign banner_enabled = section.settings.banner_enabled
  assign banner_text = section.settings.banner_text
  assign banner_discount_code = section.settings.banner_discount_code
-%}

{% if banner_enabled %}
<div class="banner" id="promotional-banner">
  <div class="banner-content">
    <div class="banner-text">
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M12 2L2 7v10c0 5.55 3.84 10 9 11 5.16-1 9-5.45 9-11V7z"/>
        <path d="M9 12l2 2 4-4"/>
      </svg>
      {{ banner_text | default: 'Black Friday Sale - Up to 70% Off Everything!' }}
      {% if banner_discount_code %}
        <span class="discount-code" onclick="copyDiscountCode('{{ banner_discount_code }}')">
          {{ banner_discount_code }}
        </span>
      {% endif %}
    </div>
    <button class="banner-close" onclick="closeBanner()" aria-label="Close banner">
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M18 6L6 18"/>
        <path d="M6 6l12 12"/>
      </svg>
    </button>
  </div>
</div>
{% endif %}

<header class="header-section" role="banner">
  <div class="header-main">
    <div class="header-container">
      <div class="header-logo">
        <a href="{{ routes.root_url }}" aria-label="Go to homepage">
          {% if logo %}
            <img src="{{ logo | image_url: width: logo_width }}" alt="{{ shop.name }}" width="{{ logo_width }}" height="{{ logo_height }}" loading="lazy">
          {% else %}
            <h1 class="shop-name">{{ shop.name }}</h1>
          {% endif %}
        </a>
      </div>

      <nav class="header-nav" role="navigation" aria-label="Main navigation">
        <ul class="nav-menu">
          {% for link in linklists[main_menu].links %}
            <li class="nav-item">
              <a href="{{ link.url }}" class="nav-link" {% if link.active %}aria-current="page"{% endif %}>
                {{ link.title }}
                {% if link.links.size > 0 %}
                  <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="6,9 12,15 18,9"/>
                  </svg>
                {% endif %}
              </a>
              {% if link.links.size > 0 %}
                <div class="nav-dropdown">
                  <ul>
                    {% for child_link in link.links %}
                      <li><a href="{{ child_link.url }}" {% if child_link.active %}aria-current="page"{% endif %}>{{ child_link.title }}</a></li>
                    {% endfor %}
                  </ul>
                </div>
              {% endif %}
            </li>
          {% endfor %}
        </ul>
      </nav>

      <div class="header-actions">
        {% if enable_search %}
          <button class="header-icon" onclick="openSearch()" aria-label="Open search">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <circle cx="11" cy="11" r="8"/>
              <path d="m21 21-4.35-4.35"/>
            </svg>
          </button>
        {% endif %}

        {% if enable_account_links %}
          <div class="account-dropdown">
            <button class="header-icon" aria-label="Account menu">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/>
                <circle cx="12" cy="7" r="4"/>
              </svg>
            </button>
            <div class="account-menu">
              <ul>
                {% if customer %}
                  <li><a href="{{ routes.account_url }}">My Account</a></li>
                  <li><a href="{{ routes.account_orders_url }}">Order History</a></li>
                  <li><a href="{{ routes.account_addresses_url }}">Addresses</a></li>
                  <li><a href="{{ routes.account_logout_url }}">Logout</a></li>
                {% else %}
                  <li><a href="{{ routes.account_login_url }}">Login</a></li>
                  <li><a href="{{ routes.account_register_url }}">Register</a></li>
                {% endif %}
              </ul>
            </div>
          </div>
        {% endif %}

        <button class="header-icon" onclick="openCart()" aria-label="Open cart">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M3 3h2l.4 2M7 13h10l4-8H5.4m1.6 8L5 3H3"/>
            <circle cx="9" cy="21" r="1"/>
            <circle cx="20" cy="21" r="1"/>
          </svg>
          {% if cart.item_count > 0 %}
            <span class="cart-count">{{ cart.item_count }}</span>
          {% endif %}
        </button>

        <button class="mobile-menu-toggle" onclick="toggleMobileMenu()" aria-label="Toggle mobile menu">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <line x1="3" y1="6" x2="21" y2="6"/>
            <line x1="3" y1="12" x2="21" y2="12"/>
            <line x1="3" y1="18" x2="21" y2="18"/>
          </svg>
        </button>
      </div>
    </div>
  </div>
</header>

<div class="mobile-overlay" id="mobile-overlay" onclick="closeMobileMenu()"></div>
<nav class="mobile-nav" id="mobile-nav" role="navigation" aria-label="Mobile navigation">
  <div class="mobile-nav-header">
    <div class="header-logo">
      {% if logo %}
        <img src="{{ logo | image_url: width: 120 }}" alt="{{ shop.name }}" width="120" height="auto" loading="lazy">
      {% else %}
        <h2 class="shop-name">{{ shop.name }}</h2>
      {% endif %}
    </div>
    <button class="mobile-nav-close" onclick="closeMobileMenu()" aria-label="Close mobile menu">
      <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M18 6L6 18"/>
        <path d="M6 6l12 12"/>
      </svg>
    </button>
  </div>
  <div class="mobile-nav-menu">
    <ul>
      {% for link in linklists[mobile_menu].links %}
        <li>
          <a href="{{ link.url }}" {% if link.active %}aria-current="page"{% endif %}>{{ link.title }}</a>
          {% if link.links.size > 0 %}
            <ul class="mobile-nav-submenu">
              {% for child_link in link.links %}
                <li><a href="{{ child_link.url }}" {% if child_link.active %}aria-current="page"{% endif %}>{{ child_link.title }}</a></li>
              {% endfor %}
            </ul>
          {% endif %}
        </li>
      {% endfor %}
    </ul>
  </div>
</nav>

{% if enable_search %}
<div class="search-overlay" id="search-overlay" onclick="closeSearch()">
  <div class="search-container" onclick="event.stopPropagation()">
    <button class="search-close" onclick="closeSearch()" aria-label="Close search">
      <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M18 6L6 18"/>
        <path d="M6 6l12 12"/>
      </svg>
    </button>
    <form class="search-form" action="{{ routes.search_url }}" method="get" role="search">
      <input
        class="search-input"
        type="search"
        name="q"
        placeholder="Search products..."
        autocomplete="off"
        aria-label="Search products"
        id="search-input"
      >
      <button class="search-button" type="submit" aria-label="Submit search">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <circle cx="11" cy="11" r="8"/>
          <path d="m21 21-4.35-4.35"/>
        </svg>
      </button>
    </form>
    <div class="search-results" id="search-results"></div>
  </div>
</div>
{% endif %}

<script>
  // Mobile menu functionality
  function toggleMobileMenu() {
    const mobileNav = document.getElementById('mobile-nav');
    const overlay = document.getElementById('mobile-overlay');
    
    mobileNav.classList.toggle('open');
    overlay.classList.toggle('open');
    
    if (mobileNav.classList.contains('open')) {
      document.body.style.overflow = 'hidden';
    } else {
      document.body.style.overflow = '';
    }
  }

  function closeMobileMenu() {
    const mobileNav = document.getElementById('mobile-nav');
    const overlay = document.getElementById('mobile-overlay');
    
    mobileNav.classList.remove('open');
    overlay.classList.remove('open');
    document.body.style.overflow = '';
  }

  // Search functionality
  function openSearch() {
    const searchOverlay = document.getElementById('search-overlay');
    const searchInput = document.getElementById('search-input');
    
    searchOverlay.classList.add('open');
    document.body.style.overflow = 'hidden';
    
    setTimeout(() => {
      searchInput.focus();
    }, 100);
  }

  function closeSearch() {
    const searchOverlay = document.getElementById('search-overlay');
    
    searchOverlay.classList.remove('open');
    document.body.style.overflow = '';
    
    // Clear search results
    const searchResults = document.getElementById('search-results');
    if (searchResults) {
      searchResults.innerHTML = '';
    }
  }

  // Predictive search
  let searchTimeout;
  const searchInput = document.getElementById('search-input');
  
  if (searchInput) {
    searchInput.addEventListener('input', function() {
      clearTimeout(searchTimeout);
      const query = this.value.trim();
      
      if (query.length >= 2) {
        searchTimeout = setTimeout(() => {
          performSearch(query);
        }, 300);
      } else {
        document.getElementById('search-results').innerHTML = '';
      }
    });
  }

  function performSearch(query) {
    fetch(`{{ routes.predictive_search_url }}?q=${encodeURIComponent(query)}&resources[type]=product&resources[limit]=6`)
      .then(response => response.json())
      .then(data => {
        displaySearchResults(data.resources.results.products);
      })
      .catch(error => {
        console.error('Search error:', error);
      });
  }

  function displaySearchResults(products) {
    const searchResults = document.getElementById('search-results');
    
    if (!products || products.length === 0) {
      searchResults.innerHTML = '<p style="text-align: center; padding: 20px; color: #666;">No products found.</p>';
      return;
    }
    
    let html = '';
    products.forEach(product => {
      const price = product.price ? `$${(product.price / 100).toFixed(2)}` : '';
      const image = product.featured_image ? product.featured_image.url : '';
      
      html += `
        <a href="${product.url}" class="search-result">
          ${image ? `<img src="${image}" alt="${product.title}" class="search-result-image">` : ''}
          <div class="search-result-info">
            <h3 class="search-result-title">${product.title}</h3>
            ${price ? `<div class="search-result-price">${price}</div>` : ''}
          </div>
        </a>
      `;
    });
    
    searchResults.innerHTML = html;
  }

  // Banner functionality
  function closeBanner() {
    const banner = document.getElementById('promotional-banner');
    if (banner) {
      banner.style.display = 'none';
      localStorage.setItem('banner-closed', 'true');
    }
  }

  function copyDiscountCode(code) {
    navigator.clipboard.writeText(code).then(() => {
      // Show success message
      const discountElement = event.target;
      const originalText = discountElement.textContent;
      discountElement.textContent = 'Copied!';
      
      setTimeout(() => {
        discountElement.textContent = originalText;
      }, 2000);
    });
  }

  // Cart functionality
  function openCart() {
    // This would integrate with your cart drawer implementation
    // For now, redirect to cart page
    window.location.href = '{{ routes.cart_url }}';
  }

  // Keyboard navigation
  document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
      closeMobileMenu();
      closeSearch();
    }
  });

  // Check if banner was previously closed
  document.addEventListener('DOMContentLoaded', function() {
    const bannerClosed = localStorage.getItem('banner-closed');
    const banner = document.getElementById('promotional-banner');
    
    if (bannerClosed === 'true' && banner) {
      banner.style.display = 'none';
    }
  });
</script>

{% schema %}
{
  "name": "Header",
  "settings": [
    {
      "type": "header",
      "content": "Banner Settings"
    },
    {
      "type": "checkbox",
      "id": "banner_enabled",
      "label": "Enable promotional banner",
      "default": true
    },
    {
      "type": "text",
      "id": "banner_text",
      "label": "Banner text",
      "default": "Black Friday Sale - Up to 70% Off Everything!"
    },
    {
      "type": "text",
      "id": "banner_discount_code",
      "label": "Discount code",
      "default": "BLACKFRIDAY70"
    },
    {
      "type": "header",
      "content": "Logo Settings"
    },
    {
      "type": "image_picker",
      "id": "logo",
      "label": "Logo image"
    },
    {
      "type": "range",
      "id": "logo_width",
      "min": 50,
      "max": 300,
      "step": 10,
      "unit": "px",
      "label": "Logo width",
      "default": 150
    },
    {
      "type": "range",
      "id": "logo_height",
      "min": 20,
      "max": 100,
      "step": 5,
      "unit": "px",
      "label": "Logo height",
      "default": 50
    },
    {
      "type": "header",
      "content": "Navigation Settings"
    },
    {
      "type": "link_list",
      "id": "main_menu",
      "label": "Main navigation menu",
      "default": "main-menu"
    },
    {
      "type": "link_list",
      "id": "mobile_menu",
      "label": "Mobile navigation menu",
      "default": "main-menu"
    },
    {
      "type": "header",
      "content": "Features"
    },
    {
      "type": "checkbox",
      "id": "enable_sticky_header",
      "label": "Enable sticky header",
      "default": true
    },
    {
      "type": "checkbox",
      "id": "enable_search",
      "label": "Enable search",
      "default": true
    },
    {
      "type": "checkbox",
      "id": "enable_cart_drawer",
      "label": "Enable cart drawer",
      "default": true
    },
    {
      "type": "checkbox",
      "id": "enable_account_links",
      "label": "Enable account links",
      "default": true
    }
  ]
}
{% endschema %}