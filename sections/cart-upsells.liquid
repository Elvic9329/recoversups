{% comment %}
Cart Upsells Section - RecoverSups Theme
Display recommended products in cart drawer and cart page
{% endcomment %}

{% if cart.item_count > 0 %}
<div class="cart-upsells section-{{ section.id }}-padding">
  <div class="page-width">
    
    <!-- Section Header -->
    <div class="cart-upsells__header">
      {% if section.settings.heading != blank %}
        <h2 class="cart-upsells__heading {{ section.settings.heading_size }}">
          {{ section.settings.heading }}
        </h2>
        
        {% if section.settings.show_description and section.settings.description != blank %}
          <div class="cart-upsells__description rte">
            {{ section.settings.description }}
          </div>
        {% endif %}
      {% endif %}
    </div>
    
    <!-- Upsell Products Grid -->
    <div class="cart-upsells__products" data-upsell-products>
      
      {% liquid
        assign upsell_products = blank
        assign cart_product_ids = cart.items | map: 'product_id'
        
        case section.settings.upsell_type
          when 'related'
            assign first_cart_product = cart.items.first.product
            if first_cart_product.related_products.size > 0
              assign related_products = first_cart_product.related_products
            else
              assign related_products = collections.supplements.products
            endif
            assign upsell_products = related_products | where: 'available', true
            
          when 'complementary'
            assign fitness_goals = cart.items | map: 'product' | map: 'metafields.goals.primary.value' | compact | uniq
            if fitness_goals.size > 0
              assign primary_goal = fitness_goals.first
              case primary_goal
                when 'muscle'
                  assign upsell_products = collections.muscle-building.products
                when 'energy'
                  assign upsell_products = collections.energy-boost.products
                when 'recovery'
                  assign upsell_products = collections.recovery.products
                when 'endurance'
                  assign upsell_products = collections.endurance.products
                when 'weight-loss'
                  assign upsell_products = collections.weight-loss.products
                else
                  assign upsell_products = collections.supplements.products
              endcase
            else
              assign upsell_products = collections.supplements.products
            endif
            
          when 'bestsellers'
            assign upsell_products = collections.bestsellers.products
            
          when 'trending'
            assign upsell_products = collections.trending.products
            
          else
            assign upsell_products = collections.supplements.products
        endcase
        
        assign filtered_products = blank
        for product in upsell_products
          unless cart_product_ids contains product.id
            assign filtered_products = filtered_products | append: product | append: ','
          endunless
        endfor
        
        assign final_products = filtered_products | split: ',' | compact
      %}
      
      {% if final_products.size > 0 %}
        <div class="upsell-products-grid" 
             style="--grid-desktop-columns: {{ section.settings.columns_desktop }};">
          
          {% for product in final_products limit: section.settings.products_to_show %}
            <div class="upsell-product-item">
              {% render 'product-card',
                 product: product,
                 show_vendor: section.settings.show_vendor,
                 show_rating: section.settings.show_rating,
                 show_quick_add: section.settings.show_quick_add,
                 show_benefits: true,
                 show_fitness_goals: true,
                 card_style: 'minimal',
                 image_size: 'medium'
              %}
            </div>
          {% endfor %}
          
        </div>
        
        <!-- View All Button -->
        {% if section.settings.show_view_all %}
          <div class="cart-upsells__view-all">
            <a href="/collections/{{ section.settings.upsell_type | default: 'supplements' }}" 
               class="button button--secondary">
              {{ section.settings.view_all_text | default: 'View All Supplements' }}
            </a>
          </div>
        {% endif %}
        
      {% else %}
        <!-- Fallback when no products available -->
        <div class="cart-upsells__empty">
          <p class="cart-upsells__empty-text">
            {{ section.settings.empty_text | default: 'Discover more products in our collection' }}
          </p>
          <a href="/collections/all" class="button button--primary">
            Shop All Products
          </a>
        </div>
      {% endif %}
      
    </div>
  </div>
</div>
{% endif %}

{% schema %}
{
  "name": "Cart Upsells",
  "tag": "section",
  "class": "section",
  "settings": [
    {
      "type": "header",
      "content": "Section Settings"
    },
    {
      "type": "text",
      "id": "heading",
      "label": "Section Heading",
      "default": "Complete Your Stack"
    },
    {
      "type": "select",
      "id": "heading_size",
      "label": "Heading Size",
      "options": [
        {
          "value": "h1",
          "label": "Large"
        },
        {
          "value": "h2", 
          "label": "Medium"
        },
        {
          "value": "h3",
          "label": "Small"
        }
      ],
      "default": "h2"
    },
    {
      "type": "checkbox",
      "id": "show_description",
      "label": "Show Description",
      "default": true
    },
    {
      "type": "textarea",
      "id": "description",
      "label": "Description",
      "default": "Add these supplements to maximize your results"
    },
    {
      "type": "header",
      "content": "Upsell Logic"
    },
    {
      "type": "select",
      "id": "upsell_type",
      "label": "Upsell Type",
      "options": [
        {
          "value": "related",
          "label": "Related Products"
        },
        {
          "value": "complementary",
          "label": "Complementary (by fitness goals)"
        },
        {
          "value": "bestsellers",
          "label": "Bestsellers"
        },
        {
          "value": "trending",
          "label": "Trending"
        }
      ],
      "default": "related"
    },
    {
      "type": "range",
      "id": "products_to_show",
      "label": "Products to Show",
      "min": 2,
      "max": 8,
      "step": 1,
      "default": 4
    },
    {
      "type": "range",
      "id": "columns_desktop",
      "label": "Columns on Desktop",
      "min": 2,
      "max": 6,
      "step": 1,
      "default": 4
    },
    {
      "type": "header",
      "content": "Product Display"
    },
    {
      "type": "checkbox",
      "id": "show_vendor",
      "label": "Show Vendor",
      "default": false
    },
    {
      "type": "checkbox",
      "id": "show_rating",
      "label": "Show Rating",
      "default": true
    },
    {
      "type": "checkbox",
      "id": "show_quick_add",
      "label": "Show Quick Add",
      "default": true
    },
    {
      "type": "checkbox",
      "id": "show_view_all",
      "label": "Show View All Button",
      "default": true
    },
    {
      "type": "text",
      "id": "view_all_text",
      "label": "View All Button Text",
      "default": "View All Supplements"
    },
    {
      "type": "text",
      "id": "empty_text",
      "label": "Empty State Text",
      "default": "Discover more products in our collection"
    },
    {
      "type": "header",
      "content": "Section Design"
    },
    {
      "type": "select",
      "id": "color_scheme",
      "label": "Color Scheme",
      "options": [
        {
          "value": "background-1",
          "label": "Background 1"
        },
        {
          "value": "background-2", 
          "label": "Background 2"
        }
      ],
      "default": "background-1"
    },
    {
      "type": "range",
      "id": "padding_top",
      "min": 0,
      "max": 100,
      "step": 4,
      "unit": "px",
      "label": "Padding top",
      "default": 36
    },
    {
      "type": "range",
      "id": "padding_bottom",
      "min": 0,
      "max": 100,
      "step": 4,
      "unit": "px",
      "label": "Padding bottom",
      "default": 36
    }
  ]
}
{% endschema %}